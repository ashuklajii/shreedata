<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî Shree Data Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="dashboard-body">

<script>
  if (localStorage.getItem('isAdminLoggedIn') !== 'true')
    window.location.href = 'admin-login.html';
</script>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand"><span>üåø</span><span>Shree<em>Data</em></span></div>
  <nav class="sidebar-nav">
    <button class="sidebar-btn active" onclick="show('overview',this)">   <span>üìä</span> Overview</button>
    <button class="sidebar-btn"        onclick="show('addProduct',this)">  <span>‚ûï</span> Add Product</button>
    <button class="sidebar-btn"        onclick="show('viewProducts',this)"><span>üì¶</span> Products</button>
    <button class="sidebar-btn"        onclick="show('viewOrders',this)">  <span>üõí</span> Orders</button>
  </nav>
  <button class="sidebar-logout" onclick="logout()"><span>üö™</span> Logout</button>
</aside>

<div class="dashboard-main">
  <div class="dash-topbar">
    <button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
    <h2 class="dash-page-title" id="dashTitle">Overview</h2>
    <div class="dash-admin-info">üë§ Admin</div>
  </div>

  <!-- OVERVIEW -->
  <div class="dash-section active" id="section-overview">
    <div class="dash-cards">
      <div class="dash-card"><div class="dash-card-icon" style="background:#d4edda">üì¶</div><div><h3 id="cntP">‚Äî</h3><p>Products</p></div></div>
      <div class="dash-card"><div class="dash-card-icon" style="background:#fff3cd">üõí</div><div><h3 id="cntO">‚Äî</h3><p>Orders</p></div></div>
      <div class="dash-card"><div class="dash-card-icon" style="background:#d1ecf1">üë•</div><div><h3 id="cntU">‚Äî</h3><p>Users</p></div></div>
      <div class="dash-card"><div class="dash-card-icon" style="background:#f8d7da">üí∞</div><div><h3 id="cntR">‚Äî</h3><p>Revenue</p></div></div>
    </div>
    <div class="dash-recent"><h3>Recent Orders</h3><div id="recentWrap"><p class="muted" style="padding:1rem">Loading...</p></div></div>
  </div>

  <!-- ADD PRODUCT -->
  <div class="dash-section" id="section-addProduct">
    <div class="dash-card-form">
      <h3>Add New Product</h3>

      <div class="upload-progress-wrap" id="uploadProgressWrap" style="display:none">
        <div class="upload-progress-label" id="uploadProgressLabel">Uploading...</div>
        <div class="upload-progress-bar"><div class="upload-progress-fill" id="uploadProgressFill" style="width:0%"></div></div>
      </div>

      <div class="alert"         id="apErr" style="display:none"></div>
      <div class="alert success" id="apSuc" style="display:none"></div>

      <form id="productForm" onsubmit="handleAddProduct(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="pName" placeholder="e.g. Cold-Pressed Coconut Oil" required/>
          </div>
          <div class="form-group">
            <label>Price (‚Çπ) *</label>
            <input type="number" id="pPrice" placeholder="e.g. 299" min="1" required/>
          </div>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <textarea id="pDesc" rows="3" placeholder="Describe the product..." required></textarea>
        </div>

        <!-- IMAGE UPLOAD -->
        <div class="form-group">
          <label>Product Image <span style="color:var(--text-light);font-weight:400;font-size:.75rem">(stored in sheet ‚Äî no Drive needed)</span></label>
          <input type="file" id="pFile" accept="image/*" style="display:none" onchange="onImagePick(this)"/>
          <div class="img-upload-zone" id="imgZone" onclick="document.getElementById('pFile').click()">
            <div class="img-upload-placeholder" id="imgPh">
              <div class="img-upload-icon">üì∑</div>
              <div class="img-upload-text">Click or drag &amp; drop image here</div>
              <div class="img-upload-hint">JPG, PNG, WEBP ‚Äî keep under 300KB for best results</div>
            </div>
            <img id="imgPrev" class="img-preview-thumb" src="" alt="" style="display:none"/>
          </div>
          <button type="button" class="img-remove-btn" id="imgRemoveBtn" style="display:none" onclick="clearImage()">‚úï Remove Image</button>
          <div id="imgSizeWarn" style="display:none;margin-top:.5rem;padding:.6rem 1rem;background:#fff3cd;border:1px solid #ffc107;border-radius:8px;font-size:.8rem;color:#856404;">
            ‚ö†Ô∏è Large image detected. Compress at <a href="https://squoosh.app" target="_blank">squoosh.app</a> for faster upload.
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Stock Quantity *</label>
            <input type="number" id="pStock" placeholder="e.g. 50" min="0" required/>
          </div>
          <div class="form-group">
            <label>Category *</label>
            <select id="pCat" required>
              <option value="">Select Category</option>
              <option>Cooking Oils</option>
              <option>Hair Oils</option>
              <option>Skin Oils</option>
              <option>Essential Oils</option>
              <option>Herbal Oils</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn-primary" id="apBtn">Add Product ‚Üí</button>
      </form>
    </div>
  </div>

  <!-- VIEW PRODUCTS -->
  <div class="dash-section" id="section-viewProducts">
    <div class="dash-table-wrap">
      <div class="dash-table-header">
        <h3>All Products</h3>
        <button class="btn-outline" onclick="loadProducts()">‚Üª Refresh</button>
      </div>
      <div class="table-responsive">
        <table class="dash-table">
          <thead><tr><th>Image</th><th>ID</th><th>Name</th><th>Price</th><th>Category</th><th>Stock</th><th>Delete</th></tr></thead>
          <tbody id="prodTbody"><tr><td colspan="7" class="table-loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- VIEW ORDERS -->
  <div class="dash-section" id="section-viewOrders">
    <div class="dash-table-wrap">
      <div class="dash-table-header">
        <h3>All Orders</h3>
        <button class="btn-outline" onclick="loadOrders()">‚Üª Refresh</button>
      </div>
      <div class="table-responsive">
        <table class="dash-table">
          <thead><tr><th>Order ID</th><th>Customer</th><th>Mobile</th><th>Address</th><th>Total</th><th>Payment</th><th>Date</th><th>Status</th><th>Update</th></tr></thead>
          <tbody id="orderTbody"><tr><td colspan="9" class="table-loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="script.js"></script>
<script>
// ‚îÄ‚îÄ Image state ‚îÄ‚îÄ
let pickedDataURL = null;

// ‚îÄ‚îÄ Section switch ‚îÄ‚îÄ
function show(id, btn) {
  document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
  btn.classList.add('active');
  document.getElementById('dashTitle').textContent =
    { overview:'Overview', addProduct:'Add Product', viewProducts:'Products', viewOrders:'Orders' }[id];
  document.getElementById('sidebar').classList.remove('open');
  if (id === 'overview')     loadOverview();
  if (id === 'viewProducts') loadProducts();
  if (id === 'viewOrders')   loadOrders();
}

function logout() {
  localStorage.removeItem('isAdminLoggedIn');
  window.location.href = 'admin-login.html';
}

// ‚îÄ‚îÄ Overview ‚îÄ‚îÄ
async function loadOverview() {
  try {
    const [pr, or, ur] = await Promise.all([
      jsonp({ action:'getProducts' }), jsonp({ action:'getOrders' }), jsonp({ action:'getUsers' })
    ]);
    const products = pr.data || [], orders = or.data || [], users = ur.data || [];
    const revenue  = orders.reduce((s, o) => s + parseFloat(o['Total Price'] || 0), 0);
    document.getElementById('cntP').textContent = products.length;
    document.getElementById('cntO').textContent = orders.length;
    document.getElementById('cntU').textContent = users.length;
    document.getElementById('cntR').textContent = '‚Çπ' + revenue.toFixed(0);
    const recent = [...orders].reverse().slice(0, 6);
    document.getElementById('recentWrap').innerHTML = recent.length
      ? `<table class="dash-table">
           <thead><tr><th>Order ID</th><th>Customer</th><th>Total</th><th>Date</th><th>Status</th></tr></thead>
           <tbody>${recent.map(o => `<tr>
             <td style="font-size:.75rem;color:#999">${o.OrderID || '‚Äî'}</td>
             <td><strong>${o['Customer Name'] || o['User Email'] || '‚Äî'}</strong></td>
             <td>‚Çπ${o['Total Price'] || 0}</td>
             <td style="font-size:.8rem">${o['Order Date'] ? new Date(o['Order Date']).toLocaleDateString('en-IN') : '‚Äî'}</td>
             <td><span class="status-badge status-${(o.Status || 'pending').toLowerCase()}">${o.Status || 'Pending'}</span></td>
           </tr>`).join('')}</tbody>
         </table>`
      : '<p class="muted" style="padding:1rem">No orders yet.</p>';
  } catch (e) {
    document.getElementById('recentWrap').innerHTML =
      `<p class="muted" style="color:#c0392b;padding:1rem">Error: ${e.message}</p>`;
  }
}

// ‚îÄ‚îÄ Image Pick ‚îÄ‚îÄ
function onImagePick(input) {
  const file = input.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { showToast('Select a valid image', 'error'); input.value = ''; return; }
  document.getElementById('imgSizeWarn').style.display = file.size > 300 * 1024 ? 'block' : 'none';

  const reader = new FileReader();
  reader.onload = ev => {
    // ‚îÄ‚îÄ Auto-compress image to max 400px wide, quality 0.7 ‚îÄ‚îÄ
    // This keeps base64 under ~100KB so chunk upload is fast and reliable
    const img = new Image();
    img.onload = () => {
      const MAX = 400;
      const scale  = Math.min(1, MAX / Math.max(img.width, img.height));
      const canvas = document.createElement('canvas');
      canvas.width  = Math.round(img.width  * scale);
      canvas.height = Math.round(img.height * scale);
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      pickedDataURL = canvas.toDataURL('image/jpeg', 0.7);

      document.getElementById('imgPrev').src           = pickedDataURL;
      document.getElementById('imgPrev').style.display = 'block';
      document.getElementById('imgPh').style.display   = 'none';
      document.getElementById('imgRemoveBtn').style.display = 'inline-flex';
      document.getElementById('imgZone').classList.add('has-image');
      document.getElementById('imgSizeWarn').style.display = 'none'; // compressed, no warning needed
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function clearImage() {
  pickedDataURL = null;
  document.getElementById('pFile').value               = '';
  document.getElementById('imgPrev').src               = '';
  document.getElementById('imgPrev').style.display     = 'none';
  document.getElementById('imgPh').style.display       = 'flex';
  document.getElementById('imgRemoveBtn').style.display = 'none';
  document.getElementById('imgSizeWarn').style.display  = 'none';
  document.getElementById('imgZone').classList.remove('has-image');
}

// Drag & Drop
window.addEventListener('DOMContentLoaded', () => {
  const zone = document.getElementById('imgZone');
  if (!zone) return;
  zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const dt = new DataTransfer(); dt.items.add(file);
      const inp = document.getElementById('pFile'); inp.files = dt.files;
      onImagePick(inp);
    }
  });
  loadOverview();
});

// ‚îÄ‚îÄ Add Product ‚Äî 100% JSONP, chunked image upload, zero CORS ‚îÄ‚îÄ
async function handleAddProduct(e) {
  e.preventDefault();
  const btn       = document.getElementById('apBtn');
  const errEl     = document.getElementById('apErr');
  const sucEl     = document.getElementById('apSuc');
  const progWrap  = document.getElementById('uploadProgressWrap');
  const progFill  = document.getElementById('uploadProgressFill');
  const progLabel = document.getElementById('uploadProgressLabel');
  errEl.style.display = 'none';
  sucEl.style.display = 'none';

  const productName = document.getElementById('pName').value.trim();
  btn.textContent    = 'Uploading...';
  btn.disabled       = true;
  progWrap.style.display = 'block';

  try {
    // ‚îÄ‚îÄ STEP 1: Send image in chunks via JSONP if image selected ‚îÄ‚îÄ
    // Each JSONP request can safely carry ~4000 chars of base64
    const CHUNK = 1500; // keep small ‚Äî base64 expands ~3x when URL-encoded
    const uploadId    = 'UP_' + Date.now();
    let   totalChunks = 0;

    if (pickedDataURL) {
      const chunks = [];
      for (let i = 0; i < pickedDataURL.length; i += CHUNK)
        chunks.push(pickedDataURL.slice(i, i + CHUNK));
      totalChunks = chunks.length;

      for (let i = 0; i < chunks.length; i++) {
        progFill.style.width  = Math.round(((i + 1) / chunks.length) * 80) + '%';
        progLabel.textContent = `Uploading image... ${i + 1}/${chunks.length}`;
        const r = await jsonp({ action: 'saveChunk', uploadId, idx: i, data: chunks[i] });
        if (!r.success) throw new Error('Chunk ' + i + ' failed: ' + r.message);
      }
    }

    // ‚îÄ‚îÄ STEP 2: Save product row (assembles chunks on server) ‚îÄ‚îÄ
    progFill.style.width  = '90%';
    progLabel.textContent = 'Saving product...';

    const res = await jsonp({
      action:      'addProduct',
      uploadId,
      totalChunks,
      name:        productName,
      price:       document.getElementById('pPrice').value,
      description: document.getElementById('pDesc').value.trim(),
      stock:       document.getElementById('pStock').value,
      category:    document.getElementById('pCat').value
    });

    progFill.style.width  = '100%';
    progLabel.textContent = '‚úì Done!';
    setTimeout(() => { progWrap.style.display = 'none'; }, 1200);

    if (res.success) {
      sucEl.innerHTML = `‚úì <strong>${productName}</strong> added!
        ${res.hasImage ? '<br/><small style="color:var(--green-mid)">‚úì Image stored in sheet</small>' : ''}
        <br/><small><a href="index.html" target="_blank" style="color:var(--green-mid)">‚Üí View on storefront</a></small>`;
      sucEl.style.display = 'block';
      document.getElementById('productForm').reset();
      clearImage();
    } else {
      throw new Error(res.message || 'Unknown error');
    }
  } catch (err) {
    progWrap.style.display = 'none';
    errEl.textContent   = '‚úó ' + err.message;
    errEl.style.display = 'block';
  }

  btn.textContent = 'Add Product ‚Üí';
  btn.disabled    = false;
}

// ‚îÄ‚îÄ Products Table ‚îÄ‚îÄ
async function loadProducts() {
  const tbody = document.getElementById('prodTbody');
  tbody.innerHTML = '<tr><td colspan="7" class="table-loading">Loading...</td></tr>';
  try {
    const res  = await jsonp({ action: 'getProducts' });
    const list = (res.data || []).filter(p => p.ProductID);
    tbody.innerHTML = list.length
      ? list.map(p => `<tr>
          <td>
            ${p['Image URL']
              ? `<img src="${p['Image URL']}" class="prod-thumb" alt="${p['Product Name']}"
                   onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
              : ''}
            <span class="prod-thumb-emoji" style="display:${p['Image URL'] ? 'none' : 'flex'}">ü´í</span>
          </td>
          <td style="font-size:.72rem;color:#999">${p.ProductID}</td>
          <td><strong>${p['Product Name']}</strong></td>
          <td><strong>‚Çπ${p.Price}</strong></td>
          <td><span class="cat-pill">${p.Category || '‚Äî'}</span></td>
          <td>${p.Stock}</td>
          <td><button class="btn-danger-sm"
            onclick="deleteProduct('${p.ProductID}','${(p['Product Name'] || '').replace(/'/g, "\\'")}')">
            Delete</button></td>
        </tr>`).join('')
      : '<tr><td colspan="7" class="table-loading">No products found.</td></tr>';
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="7" class="table-loading" style="color:#c0392b">Error: ${e.message}</td></tr>`;
  }
}

async function deleteProduct(id, name) {
  if (!confirm('Delete "' + name + '"?')) return;
  try {
    const res = await jsonp({ action: 'deleteProduct', productId: id });
    if (res.success) { showToast('Deleted!'); loadProducts(); }
    else showToast(res.message || 'Delete failed', 'error');
  } catch (e) { showToast(e.message, 'error'); }
}

// ‚îÄ‚îÄ Orders Table ‚îÄ‚îÄ
async function loadOrders() {
  const tbody = document.getElementById('orderTbody');
  tbody.innerHTML = '<tr><td colspan="9" class="table-loading">Loading...</td></tr>';
  try {
    const res  = await jsonp({ action: 'getOrders' });
    const list = res.data || [];
    tbody.innerHTML = list.length
      ? list.map(o => `<tr>
          <td style="font-size:.72rem;color:#999;white-space:nowrap">${o.OrderID || '‚Äî'}</td>
          <td><strong>${o['Customer Name'] || '‚Äî'}</strong><br/>
              <small style="color:#999">${o['User Email'] || ''}</small></td>
          <td>${o.Mobile || '‚Äî'}</td>
          <td style="max-width:160px;font-size:.8rem;line-height:1.4;color:#555">
            ${o.Address || '‚Äî'}${o.City ? ', ' + o.City : ''}${o.State ? ', ' + o.State : ''} ${o.Pincode || ''}
          </td>
          <td><strong>‚Çπ${o['Total Price'] || 0}</strong></td>
          <td><span class="cat-pill">${o['Payment Method'] || 'COD'}</span></td>
          <td style="font-size:.8rem;white-space:nowrap">
            ${o['Order Date'] ? new Date(o['Order Date']).toLocaleDateString('en-IN') : '‚Äî'}
          </td>
          <td><span class="status-badge status-${(o.Status || 'pending').toLowerCase()}">${o.Status || 'Pending'}</span></td>
          <td>
            <select class="status-select" onchange="updateStatus('${o.OrderID}', this.value)">
              <option ${o.Status === 'Pending'   ? 'selected' : ''}>Pending</option>
              <option ${o.Status === 'Shipped'   ? 'selected' : ''}>Shipped</option>
              <option ${o.Status === 'Delivered' ? 'selected' : ''}>Delivered</option>
              <option ${o.Status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </td>
        </tr>`).join('')
      : '<tr><td colspan="9" class="table-loading">No orders yet.</td></tr>';
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="9" class="table-loading" style="color:#c0392b">Error: ${e.message}</td></tr>`;
  }
}

async function updateStatus(orderId, status) {
  try {
    const res = await jsonp({ action: 'updateOrderStatus', orderId, status });
    if (res.success) showToast('Status updated to ' + status + '!');
    else showToast(res.message || 'Update failed', 'error');
  } catch (e) { showToast(e.message, 'error'); }
}
</script>
</body>
</html>